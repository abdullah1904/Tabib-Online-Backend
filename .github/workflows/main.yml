name: Build and Deploy Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build --no-cache \
            --build-arg PORT=${{ secrets.PORT }} \
            --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
            --build-arg ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }} \
            --build-arg ACCESS_TOKEN_EXPIRY=${{ secrets.ACCESS_TOKEN_EXPIRY }} \
            --build-arg REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }} \
            --build-arg REFRESH_TOKEN_EXPIRY=${{ secrets.REFRESH_TOKEN_EXPIRY }} \
            --build-arg CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --build-arg CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --build-arg CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --build-arg MAIL_USER=${{ secrets.MAIL_USER }} \
            --build-arg MAIL_PASS=${{ secrets.MAIL_PASS }} \
            --build-arg GROQ_API_KEY=${{ secrets.GROQ_API_KEY }} \
            --build-arg GROQ_PRIMARY_MODEL=${{ secrets.GROQ_PRIMARY_MODEL }} \
            --build-arg GROQ_SECONDARY_MODEL=${{ secrets.GROQ_SECONDARY_MODEL }} \
            --build-arg QDRANT_URL=${{ secrets.QDRANT_URL }} \
            --build-arg QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }} \
            --build-arg QDRANT_COLLECTION_NAME=${{ secrets.QDRANT_COLLECTION_NAME }} \
            --build-arg COHERE_API_KEY=${{ secrets.COHERE_API_KEY }} \
            --build-arg COHERE_EMBEDDING_MODEL=${{ secrets.COHERE_EMBEDDING_MODEL }} \
            --build-arg LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING }} \
            --build-arg LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT }} \
            --build-arg LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }} \
            --build-arg LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }} \
            -t abdullah2215/tabib-online-backend:latest .

      - name: Push Docker image to registry
        run: |
          docker push abdullah2215/tabib-online-backend:latest